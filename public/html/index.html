<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Testing blockly</title>
  <script src="../client/blockly_compressed.js" charset="utf-8"></script>
  <script src="../client/blocks_compressed.js" charset="utf-8"></script>
  <script src="../client/javascript_compressed.js" charset="utf-8"></script>

  <script src="../client/acorn.js" charset="utf-8"></script>
  <script src="../client/interpreter.js" charset="utf-8"></script>
  <script src="../client/msg/js/en.js" charset="utf-8"></script>

  <style media="screen">
  body {
    padding: 0;
    margin: 0
  }
  #blocklyDiv {
      position: fixed;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
    }

  #runButton {
    position: absolute;
    top: 30px;
    right: 30px;
    padding: 10px;
    background-color: rgba(255, 255, 255, 50%);
    color: #999;
    border-radius: 5px;
  }
  </style>

</head>
<body>
  <div id="blocklyDiv"></div>
  <button id="runButton" onclick="runCode(true); return">Copy FS Code to Clipboard</button>
</body>
<!-- Define your custom blocks -->
<script src="../client/myBlocksInit.js" charset="utf-8"></script>
<!-- Define your custom blocks generated code -->
<script src="../client/myBlocks.js" charset="utf-8"></script>
<!-- Init API for your JS Interpreter -->
<!-- <script src="myInterpreter.js" charset="utf-8"></script> -->
<!-- Inject your workspace with categories and blocks -->
<script src="../client/workspace.js" charset="utf-8"></script>
<script>



function runCode(highlighting) {

  var fsPrefix = `
    FeatureScript 1389;
    import(path : "onshape/std/geometry.fs", version : "1389.0");
  `
  
  var fsCode = Blockly.JavaScript.workspaceToCode(workspace);


  // TODO: The below modifies the opening lines of the code depending on the presence of precondition, this is a massive hack and should be fixed
    // break the textblock into an array of lines
  var lines = fsCode.split('\n');
  var firstLine = lines[0];
  console.log("First line: " + firstLine)
  if (firstLine.includes("var"))
  {
    // remove one line, starting at the first position
    lines.splice(0,1);
  }else if(!firstLine.includes("precondition")){
    console.log(lines);
    //lines.splice(0, 0, "precondition{} \n { var i = 0;")
  }
  // join the array back into a single string
  var fsCodeNoVar = lines.join('\n');
  

  fsCode =  fsPrefix + fsCodeNoVar;
  console.log(fsCode);
  copyToBlockly(fsCode);
  copyToClipboard(fsCode);
  tst();
  // TODO: The following shows execution of code in sync with it running, would be very helpful for troubleshooting.
  // if (highlighting)
  //   Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
  // else
  //   Blockly.JavaScript.STATEMENT_PREFIX = null;

  // var code = Blockly.JavaScript.workspaceToCode(workspace);

  // var intrepreterAvailable = false;
  // try {
  //   myInterpreter = new Interpreter(code, initApi);
  //   intrepreterAvailable = true;
  // } catch (e) {
  //   console.log("You are using eval() function consider using Interpreter\nhttps://developers.google.com/blockly/guides/app-integration/running-javascript#js_interpreter");
  // } finally {
  //   if (intrepreterAvailable) {
  //     nextStep();
  //   } else {
  //     eval(code);
  //   }
  // }
  // workspace.highlightBlock(null);

}
function copyToClipboard(text) {
    var dummy = document.createElement("textarea");
    // to avoid breaking orgain page when copying more words
    // cant copy when adding below this code
    // dummy.style.display = 'none'
    document.body.appendChild(dummy);
    //Be careful if you use texarea. setAttribute('value', value), which works with "input" does not work with "textarea". â€“ Eduard
    dummy.value = text;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
}

//updated
async function updateFeatureStudioContents(fSId, sourceMicroversion, fsCode) {
  
  console.log('FeatureScript ID:')
  console.log(fSId)
  console.log('SourceMicroversion:')
  console.log(sourceMicroversion)
  requested = {"contents": "testing from onshape", "serializationVersion":"1.1.20", "sourceMicroversion": `${sourceMicroversion}`, "rejectMicroversionSkew": true}
  console.log('New Request Body:')
  console.log(requested)
 
  try {
        const response = await fetch(`/api/featurestudiosThree${window.location.search}&blockly=${fSId}`, { method: 'POST', body: JSON.stringify(requested), headers: { "Accept": "application/vnd.onshape.v1+json", "Content-Type": "application/json"}})
        const result = await response.json();
        return result;
    } catch (error) {
        console.error(error);
    }
}

function tst(){
  requested = {
    "contents": "testing from onshape", 
    "serializationVersion":"1.1.20", 
    "sourceMicroversion": "7c3746d1f8a8b5c62721493c", 
    "rejectMicroversionSkew": "True"
  };

  fetch(`/api/featurestudiosThree${window.location.search}&blockly=50029bb62ea890b577be3177`, { 
    method: 'POST', 
    body: JSON.stringify(requested), 
    headers: { 
      "Accept": "application/vnd.onshape.v1+json", 
      "Content-Type": "application/json"
    }
  })
  .then(response => response.json())
  .then(data => console.log(data));
}



// Get FeatureStudio Contents

async function getFeatureStudioContents(fSId) {
  // Gets the FeatureStudio in the Document

  /*
  fSId = `blockly=50029bb62ea890b577be3177`

  console.log(`/api/featurestudios${window.location.search}&${fSId}`)
  */

  try {
        const response = await fetch(`/api/featurestudios${window.location.search}&blockly=${fSId}`, { headers: { 'Accept': 'application/json' } })
        const featurestudioContents = await response.json();
        return featurestudioContents;
    } catch (error) {
        console.error(error);
    }
}



// Get FeatureStudio ID
async function getFeatureStudio() {
    try {
        const response = await fetch(`/api/documents/d${window.location.search}`, { headers: { 'Accept': 'application/json' } })
        const featurestudios = await response.json();
        return featurestudios;
    } catch (error) {
        console.error(error);
    }
};



async function copyToBlockly(fsCode) {
  console.log('Making sure fscode came in right inside blockly:');
  console.log(fsCode);
  const featureStudioID = await getFeatureStudio();
  console.log('FeatureStudio ID from inside copyToBlocky:');
  console.log(featureStudioID);
  const featurestudioContents = await getFeatureStudioContents(featureStudioID[0].id);
  console.log('Contents of the FeatureStudio:');
  console.log(featurestudioContents);
  //const result = await updateFeatureStudioContents(featureStudioID[0].id, featurestudioContents.sourceMicroversion, fsCode)
  //console.log(result)
}



</script>
</html>
